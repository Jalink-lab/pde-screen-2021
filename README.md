# Dynamic FRET-FLIM based screens of signal transduction pathways: a feasibility study
by: Rolf Harkes, Olga Kukk, Sravasti Mukherjee, Jeffrey Klarenbeek, Bram van den Broek, Kees Jalink

This repository contains the code accompanying [this paper](https://www.google.com) and has been used for all analysis and generation of the figures. All raw data can be found in [this zenodo repository](https://zenodo.org/record/4746173).

[![DOI](https://zenodo.org/badge/DOI/10.5281/zenodo.4746173.svg)](https://doi.org/10.5281/zenodo.4746173)

# Layout
* Running `analyse_data.py` on the raw data produces the results.
* `PDE_Analysis` contains the functions for the analysis of the data.
* `PDE_Display` contains the functions for displaying the results.
* The folder `Figures` contains the jupyter notebooks that use the result of `analyse_data.py` to generate the figures.

# How to setup the environment
We have used [PyCharm](https://www.jetbrains.com/pycharm/) and [Miniconda](https://docs.conda.io/en/latest/miniconda.html) to write and execute the code. 
To create an environment with all the packages required you can run the following command from a terminal `conda create -f environment.yml`.
After the environment is created you can activate it with `conda activate PDE_Screening`.
For more information on managing environments, see the [conda documentation](https://docs.conda.io/projects/conda/en/4.6.1/user-guide/getting-started.html#managing-envs).

# Detailed explaination of the method
The experimental data is stored in on hard drive (we have called this folder: Screening_Data_Notanalyzed) which contains subfolders corresponding to the date and type of experiment. Each subfolder includes: intensity time-lapse data in tiff files for each well; lifetime tiff files containing the two components of the donor lifetime resulting from LASX fitting; a descriptive file containing the 96-well plate layout for each experiment as a .txt file.
Data analysis is started with the Python script [`analyse_data.py`](analyse_data.py) which iterates through all the data in subfolders and calls various other methods located in the folder [PDE_Analysis](PDE_Analysis\__init__.py). Python was run either from Spyder or PyCharm. [`Analyse_data.py`](analyse_data.py) allows data to be included or excluded flexibly. Data have been analyzed well-by-well, experiment-by-experiment, and all data is pooled. The output of [`analyse_data.py`](analyse_data.py) is stored in a new folder named Screening_Result which mirrors the subfolder structure of the input data. The location of Screening_Result can be set at [line 36](analyse_data.py#L36)
* First, cells are segmented using the deep learning algorithm Cellpose. Due to minimal cell movement during acquisition, intensity data can be derived from all frames combined. The method [save_mean_in_time_of_tiffs](PDE_Analysis/__init__.py#L15) sums the intensity data from all frames and writes a single average intensity tiff file per FOV for use in cell segmentation. Cell segmentation is then performed once per FOV by calling the method [segment_cells.py](PDE_Analysis/__init__.py#L48). This script implements the Cellpose software for deep-learning based cell segmentation. The resulting images (one per well/FOV) have the suffix `_labelmap.tif` and contain numbered ROIs that contain the cells for further analysis.
* [`Analyse_data.py`](analyse_data.py) then reads the plate layout of the experiment(s) and links the corresponding conditions to the analyzed data for each well. Using the method [get_lifetimes](PDE_Analysis/__init__.py#L81), it calculates lifetime traces per cell (ROI) and determines potential error conditions. [fit_lifetime_traces](PDE_Analysis/__init__.py#L122) implements a sigmoid fit of the decaying part of the cAMP response and generates intensity data. Four csv files are written to the Screening_Result folder during this step: lifetimetraces are saved as wellname_tau.csv, intensitytraces are saved as wellname_int.csv, error conditions as wellname_errors.csv, and the fitting results as wellname_fit.csv.  The dataframes with lifetime traces for each of the wells of that experiment are also concatenated to a file all_results.csv that is intended for data inspection/visualization. 
    * [get_lifetimes](PDE_Analysis/__init__.py#L81) extracts, for each ROI in the segmentation image (labelmap.tif) and for every time- lapse frame, the average lifetime τ from the two fitted component amplitudes (Int1 and Int2) as: τ=  (0.6×Int1+3.4×Int2)/(Int1+Int2). This results in lifetime traces, i.e. a time-lapse array of lifetimes per cell. The routine also returns intensitytraces, ROI_size and potential error conditions.
    * [fit_lifetime_traces](PDE_Analysis/__init__.py#L122) fits the logistic function (using the python curve_fit function) to the extracted lifetimetraces. Parameters of the logistic function fit are unpacked and returned in a pandas dataframe named fitresults along with the dataframe containing updated errortraces. The used logistic function is: τ= τ_0+τ_R/(1+e^(-4(t-t_m)/r) )   where τ0 is the value of the baseline lifetime, τR is the range of lifetimes, tm is the time at the midpoint and r is the breakdown time. r represents the time required to break down the entire range if the breakdown was constant at the value of the midpoint. Only data of the decaying phase of the experiment were included in the fit; i.e. the fitrange started at the maximum value detected in the first 150 frames (compare Figs. 3 and 6). In case Forskolin was used for end-point calibration (in GPCR mediated cAMP elevation experiments), the fitrange ended just before forskolin addition. For caged-cAMP experiments the fitrange was extended to the end of the experimental data.
    * From the pandas dataframes, data were then selected for plotting in various Jupyter notebooks  according to standard procedures. They can be found in the [Figures folder](Figures)
    * For routine data inspection, plotting and scrolling cell-by-cell through the data we made [ROI_fit_inspector](ROI_Fitinspector.ipynb). A jupyter notebook that can display each ROI with the corresponding goodness of fit, calculated from the root-mean-square deviation (RMSD) and the corresponding mean absolute percentage error (MAPE). Only traces with MAPE below 1% were included in experiment evaluations and statistical analysis. For the plots provided in Results, all individual ROIs were also filtered based on minimal cell size (>25 pixels) and brightness (>50 mean gray values) and only ROIs with no error condition qualified for final evaluation and statistical analysis.
